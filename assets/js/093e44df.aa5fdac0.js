"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4339],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return m}});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var s=r.createContext({}),u=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(a),m=n,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||o;return a?r.createElement(h,i(i({ref:t},p),{},{components:a})):r.createElement(h,i({ref:t},p))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:n,i[1]=l;for(var u=2;u<o;u++)i[u]=a[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}d.displayName="MDXCreateElement"},5621:function(e,t,a){a.r(t),a.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return l},metadata:function(){return u},toc:function(){return c}});var r=a(7462),n=a(3366),o=(a(7294),a(3905)),i=["components"],l={id:"restore-backup",title:"How to restore a Backup on a different server or upgrade Ubuntu?",sidebar_label:"Restore Backup/Upgrade Ubuntu"},s=void 0,u={unversionedId:"restore-backup",id:"restore-backup",title:"How to restore a Backup on a different server or upgrade Ubuntu?",description:"Theoretically it could happen that your system drive fails or that you need to update the Ubuntu version.",source:"@site/docs/restore-backup.md",sourceDirName:".",slug:"/restore-backup",permalink:"/Nextcloud-NAS-Guide/docs/restore-backup",draft:!1,editUrl:"https://github.com/szaimen/Nextcloud-NAS-Guide/edit/main/docs/restore-backup.md",tags:[],version:"current",frontMatter:{id:"restore-backup",title:"How to restore a Backup on a different server or upgrade Ubuntu?",sidebar_label:"Restore Backup/Upgrade Ubuntu"},sidebar:"docs",previous:{title:"Restore system",permalink:"/Nextcloud-NAS-Guide/docs/restore-system"},next:{title:"Backup drives - PC access",permalink:"/Nextcloud-NAS-Guide/docs/access-backup"}},p={},c=[{value:"Preparations (if your server doesn&#39;t work because of a failed system drive)",id:"preparations-if-your-server-doesnt-work-because-of-a-failed-system-drive",level:2},{value:"Preparations (if you want to upgrade Ubuntu)",id:"preparations-if-you-want-to-upgrade-ubuntu",level:2},{value:"Execution",id:"execution",level:2},{value:"Reinstall Apps and Addons",id:"reinstall-apps-and-addons",level:2},{value:"Necessary are those",id:"necessary-are-those",level:3},{value:"Now your Nextcloud should work again completely!",id:"now-your-nextcloud-should-work-again-completely",level:4},{value:"Optional are those",id:"optional-are-those",level:3}],d={toc:c};function m(e){var t=e.components,a=(0,n.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Theoretically it could happen that your system drive fails or that you need to update the Ubuntu version.\nIn those cases you need to reinstall Ubuntu and thus restore a backup on a different server (it looks like it is a different server for the scripts)."),(0,o.kt)("p",null,"Here is what you need to do in those cases:"),(0,o.kt)("h2",{id:"preparations-if-your-server-doesnt-work-because-of-a-failed-system-drive"},"Preparations (if your server doesn't work because of a failed system drive)"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Buy a new with your server compatible internal SSD (recommended specifications describe ",(0,o.kt)("a",{parentName:"li",href:"./hardware-recommendations#general-hardware-recommendations"},"here"),")"),(0,o.kt)("li",{parentName:"ol"},"Put the new drive into your server")),(0,o.kt)("h2",{id:"preparations-if-you-want-to-upgrade-ubuntu"},"Preparations (if you want to upgrade Ubuntu)"),(0,o.kt)("ol",{start:0},(0,o.kt)("li",{parentName:"ol"},"If Pi-hole is set up as your local DNS-server, disable it in your router as you will not be able to use the internet at all when your server is powered off."),(0,o.kt)("li",{parentName:"ol"},"Update to the latest major Nextcloud release by following the instructions here: ",(0,o.kt)("a",{parentName:"li",href:"./major-update"},"click here"),(0,o.kt)("admonition",{parentName:"li",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Please read carefully through all info there, especially the ",(0,o.kt)("inlineCode",{parentName:"p"},"Things to check before updating")," section before updating. (E.g. it is not recommended to update to any new major Nextcloud release before the first point release: all info there is valid here, too.)")),(0,o.kt)("admonition",{parentName:"li",type:"warning"},(0,o.kt)("p",{parentName:"admonition"},"At least Nextcloud 24 is required to proceed below, so make sure that you upgrade at least to this version!"))),(0,o.kt)("li",{parentName:"ol"},"Create a backup of your server (",(0,o.kt)("a",{parentName:"li",href:"./manual-backup"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Only if the backup (from step 2) was created successfully (otherwise skip this 3rd step!), get your ",(0,o.kt)("inlineCode",{parentName:"li"},"Off-Shore Backup HDD"),", connect it to your server and create a new off-shore backup by running:",(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"sudo sed -i 's|^DAYS_SINCE_LAST_BACKUP.*|DAYS_SINCE_LAST_BACKUP=1000|' /var/scripts/off-shore-rsync-backup.sh \\\n&& sudo bash /var/scripts/off-shore-rsync-backup.sh\n")),(0,o.kt)("admonition",{parentName:"li",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"You should really only create a new off-shore backup if the backup from step 2 was created successfully!"))),(0,o.kt)("li",{parentName:"ol"},"Use your ",(0,o.kt)("strong",{parentName:"li"},"last chance")," and find out if you still have the passphrase of your backup stored at a safe place by comparing it with the output of:",(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'sudo grep "ENCRYPTION_KEY" /var/scripts/daily-borg-backup.sh\n')),(0,o.kt)("admonition",{parentName:"li",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"If you don't have it stored, just ",(0,o.kt)("strong",{parentName:"p"},"note it down")," another time. ",(0,o.kt)("strong",{parentName:"p"},"This is crucial!"),(0,o.kt)("br",null),"\n(because this is the last chance to retrieve the password from your server)")))),(0,o.kt)("h2",{id:"execution"},"Execution"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Shut down")," your server by pressing the power button"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Disconnect")," all external drives from your server"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Execute")," the complete Basic setup section (",(0,o.kt)("a",{parentName:"li",href:"./basic-setup"},"this section"),")",(0,o.kt)("br",null),(0,o.kt)("admonition",{parentName:"li",type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Don't go any further and stop at the beginning of the next section!",(0,o.kt)("br",null),"\n(This is the last step that shall get executed: ",(0,o.kt)("a",{parentName:"p",href:"./usb-boot"},"click here"),")"))),(0,o.kt)("li",{parentName:"ol"},"If you are done with the basic setup section, run the manual update once (",(0,o.kt)("a",{parentName:"li",href:"./update-manually"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Please ",(0,o.kt)("strong",{parentName:"li"},"don't")," connect the backup HDD to your server, yet or ",(0,o.kt)("strong",{parentName:"li"},"disconnect")," the backup HDD from your server!"),(0,o.kt)("li",{parentName:"ol"},"Now run the restore-backup script by executing:",(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"wget https://raw.githubusercontent.com/nextcloud/vm/main/not-supported/restore-backup.sh \\\n&& sudo bash restore-backup.sh\n"))),(0,o.kt)("li",{parentName:"ol"},"Enter your password"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Confirm")," that you want to restore your server from backup"),(0,o.kt)("li",{parentName:"ol"},"Press ",(0,o.kt)("inlineCode",{parentName:"li"},"OK")," to start searching for new backup drives"),(0,o.kt)("li",{parentName:"ol"},"Now ",(0,o.kt)("strong",{parentName:"li"},"connect")," one of your backup drives (most likely the daily backup HDD) to your server (you have 1 minute)"),(0,o.kt)("li",{parentName:"ol"},"Choose the ",(0,o.kt)("strong",{parentName:"li"},"BTRFS/NTFS partition")," that shall get mounted"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Select")," one found valid backup repository"),(0,o.kt)("li",{parentName:"ol"},"Enter the ",(0,o.kt)("strong",{parentName:"li"},"passphrase")," that was used to encrypt the backup"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Select")," the ",(0,o.kt)("inlineCode",{parentName:"li"},"backup archive")," that shall get restored (most likely the newest one if your system was in a working state when the backup was created)"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Choose")," if you want to check if the backup extracting works (this is up to you)",(0,o.kt)("br",null),"\n(If you choose yes and it takes too long, you can cancel it by pressing ",(0,o.kt)("inlineCode",{parentName:"li"},"[CTRL] + [C]"),". Then start from step 5 again and simply skip it.)"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("strong",{parentName:"li"},"Confirm")," that you want to restore the backup"),(0,o.kt)("li",{parentName:"ol"},"Now wait until you see the next popup! (This can take a while.)"),(0,o.kt)("li",{parentName:"ol"},"It should now report that the restore was completed and you should connect all drives now. So please ",(0,o.kt)("strong",{parentName:"li"},"connect all external drives")," now that were connected to your old server!"),(0,o.kt)("li",{parentName:"ol"},"Press ",(0,o.kt)("inlineCode",{parentName:"li"},"[ENTER]")," so that they get mounted"),(0,o.kt)("li",{parentName:"ol"},"Now you should see a popup were it is recommended to open your nextcloud web interface to confirm that the restore was successful. Do so by opening the suggested link. E.g. ",(0,o.kt)("inlineCode",{parentName:"li"},"https://192.168.178.144"),". After you've confirmed that Nextcloud works, press ",(0,o.kt)("inlineCode",{parentName:"li"},"[ENTER]")),(0,o.kt)("li",{parentName:"ol"},"Now it will report to you that you need to reinstall a lot of apps/addons in case they were installed on your old server. This is what you will do next. Press ",(0,o.kt)("inlineCode",{parentName:"li"},"[ENTER]")," to exit the script.")),(0,o.kt)("h2",{id:"reinstall-apps-and-addons"},"Reinstall Apps and Addons"),(0,o.kt)("p",null,"If the Nextcloud web interface works as expected, you will need to reinstall all apps/addons that were installed on your old server."),(0,o.kt)("h3",{id:"necessary-are-those"},"Necessary are those"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Reinstall Geoblocking (",(0,o.kt)("a",{parentName:"li",href:"./geoblock"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Reinstall Disk Monitoring (",(0,o.kt)("a",{parentName:"li",href:"./smart"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Reinstall Fail2Ban (",(0,o.kt)("a",{parentName:"li",href:"./fail2ban"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Reinstall ClamAV (",(0,o.kt)("a",{parentName:"li",href:"./clamav"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Reinstall SMTP Mail (",(0,o.kt)("a",{parentName:"li",href:"./smtp-mail"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Reinstall DDclient (",(0,o.kt)("a",{parentName:"li",href:"./configure-ddclient"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Reconfigure Port Forwarding (",(0,o.kt)("a",{parentName:"li",href:"./port-forwarding"},"instructions"),")"),(0,o.kt)("li",{parentName:"ol"},"Reactivate TLS for your Nextcloud Domain (",(0,o.kt)("a",{parentName:"li",href:"./activate-tls"},"instructions"),")")),(0,o.kt)("h4",{id:"now-your-nextcloud-should-work-again-completely"},"Now your Nextcloud should work again completely!"),(0,o.kt)("h3",{id:"optional-are-those"},"Optional are those"),(0,o.kt)("p",null,"(You only need to reinstall them ",(0,o.kt)("strong",{parentName:"p"},"if they were installed before"),")"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Reenable the Firewall on your server (",(0,o.kt)("a",{parentName:"li",href:"./firewall"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall OnlyOffice for Nextcloud (",(0,o.kt)("a",{parentName:"li",href:"./onlyoffice"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall High-Performance backend for Nextcloud Talk (",(0,o.kt)("a",{parentName:"li",href:"./hpb"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall Push Notifications for Nextcloud (",(0,o.kt)("a",{parentName:"li",href:"./notify_push"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall Whiteboard for Nextcloud (",(0,o.kt)("a",{parentName:"li",href:"./whiteboard"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall Pico CMS for Nextcloud (",(0,o.kt)("a",{parentName:"li",href:"./pico"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall Extract for Nextcloud (",(0,o.kt)("a",{parentName:"li",href:"./extract"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall Previewgenerator (",(0,o.kt)("a",{parentName:"li",href:"./previewgenerator"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall PDF annotations (",(0,o.kt)("a",{parentName:"li",href:"./pdfannotate"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall Vaultwarden (formerly known as Bitwarden RS) (",(0,o.kt)("a",{parentName:"li",href:"./vaultwarden"},"instructions"),")",(0,o.kt)("admonition",{parentName:"li",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Attention! Please use the ",(0,o.kt)("strong",{parentName:"p"},"same domain")," that you've used before for Bitwarden RS or Vaultwarden (if you've had Bitwarden RS or Vaultwarden installed on your old server!)"))),(0,o.kt)("li",{parentName:"ul"},"Reinstall Pi-hole (",(0,o.kt)("a",{parentName:"li",href:"./pi-hole"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall PiVPN (",(0,o.kt)("a",{parentName:"li",href:"./pivpn"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Redo the change of the update time (",(0,o.kt)("a",{parentName:"li",href:"./change-update-time"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Redo the change to only allow access to your server from inside your home network (",(0,o.kt)("a",{parentName:"li",href:"./home-access-only"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall Plex Media Server (",(0,o.kt)("a",{parentName:"li",href:"./pms"},"instructions"),")",(0,o.kt)("admonition",{parentName:"li",type:"note"},(0,o.kt)("p",{parentName:"admonition"},"When reinstalling Plex, all drives that Plex shall have access to need to be mounted to the server! (Otherwise there could appear some problems.) You can make sure that this is the case by connecting all drives to your server and rebooting your sever before reinstalling Plex!"))),(0,o.kt)("li",{parentName:"ul"},"Reinstall Remotedesktop (",(0,o.kt)("a",{parentName:"li",href:"./remotedesktop"},"instructions"),")"),(0,o.kt)("li",{parentName:"ul"},"Reinstall other apps that you might have had installed before (",(0,o.kt)("a",{parentName:"li",href:"./more-apps"},"overview"),") ")),(0,o.kt)("admonition",{title:"daily backup",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Please note that the next scheduled daily backup will take a long time because the local borgbackup cache has to be rebuilt. So don't be surprised if this is the case since it is completely normal!")))}m.isMDXComponent=!0}}]);